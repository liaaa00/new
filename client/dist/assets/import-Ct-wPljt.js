import{i as G,r as ge,h as l,j as E,U as N,I as te,L as me,k as de,T as _,l as fe,n as C,q as H,s as re,t as U,E as $,S as pe,v as k,w as ye}from"./index-D8m7b25O.js";var v=(e=>(e.Update="update",e.Delete="delete",e.Add="add",e.Link="link",e.Async="async",e))(v||{});const oe=200,le=200,ie=200,be=200,he=200;async function Re(e,a){const r=await e.getName();return async s=>{try{const t=await e.addRecords(s.map(n=>n.data));s.forEach((n,d)=>{t[d]&&(n.result=t[d],n.status=_.Success)}),a(l.onAddRecords,{stage:"addRecords",data:{success:s,message:{text:"importInfo.addRecordsMessage",params:{table:r}}}})}catch(t){$({title:"addRecordsFailure",message:String(t),error:t}),s.forEach(n=>{n.status=_.Error}),a(l.onAddRecords,{stage:"addRecords",data:{error:s}})}}}async function we(e,a){const r=await e.getName();return async s=>{try{const t=await e.setRecords(s.map(n=>n.data).flat());s.forEach((n,d)=>{t[d]&&(n.result=t[d],n.status=_.Success)}),a(l.onUpdateRecords,{stage:"updateRecords",data:{success:s,message:{text:"importInfo.updateRecordsMessage",params:{table:r}}}})}catch(t){$({title:"updateRecordsFailure",message:String(t),error:t}),s.forEach(n=>{n.status=_.Error}),a(l.onUpdateRecords,{stage:"updateRecords",data:{error:s}})}}}async function Ie(e,a){const r=await e.getName();return async s=>{try{const t=await e.deleteRecords(s.map(n=>n.data).flat());t&&s.forEach(n=>{n.result=t,n.status=_.Success}),a(l.onDeleteRecords,{stage:"deleteRecords",data:{success:s,message:{text:"importInfo.deleteRecordsMessage",params:{table:r}}}})}catch(t){$({title:"deleteRecordsFailure",message:String(t),error:t}),s.forEach(n=>{n.status=_.Error}),a(l.onDeleteRecords,{stage:"deleteRecords",data:{error:s}})}}}async function Te(e,a,r=oe,s=500,t){await k(r,s,e,await Re(a,t))}async function Fe(e,a,r=ie,s=500,t){return await k(r,s,e,await we(a,t))}async function Se(e,a,r=le,s=500,t){return await k(r,s,e,await Ie(a,t))}async function xe(e,a,r,s,t){return e===a?null:r===G.merge_direct||a===null?await E.getCell(s,t,e):await E.getCell(s,t,a)}async function ae(e,a,r=!1,s,t){try{const n=await ye.base.getTable(e),[d,u,y]=await Promise.all([n.getName(),n.getFieldList(),n.getFieldMetaList()]);s(l.onReadFieldMap,{stage:"readFieldMap",data:{message:{text:"importInfo.getTable",params:{name:d,id:e}}}});const b=y.filter(c=>c.isPrimary)[0].id;return{id:e,table:n,name:d,primaryField:b,indexId:t?.length?t:[b],root:r,fields:u.reduce((c,g)=>(c[g.id]=g,c),{}),fieldMaps:a}}catch(n){throw $({title:"getTableFailure",message:String(n),error:n,notice:!0,noticeParams:{text:"message.getTableFailure",params:{id:e}}}),n}}async function se(e,a,r=1e4,s=0){const t=[];return await k(r,s,e,async n=>{await Promise.allSettled(n.map(async d=>{const u=await a(d);Array.isArray(u)?t.push(...u):t.push(u)}))}),t}async function ce(e,a,r,s,t,n,d,u){if(!E.asyncTypes.includes(a.field.type))return null;const y=await E.normalization(e,a);if(!y)return null;const b=[y],A={table:{name:s[a.table].name,id:a.table},action:v.Async,data:b,result:void 0,status:_.Wait,target:u,asyncField:a,value:e,field:r};n.push(A)}async function ue(e,a,r,s,t,n,d,u){if(!a.children?.length)return null;const{linkConfig:y}=a,{allowAdd:b,primaryKey:A}=y??{};if(!A||b===void 0)return null;const c=await E.normalization(e,a),g=s[a.field.property.tableId],X=t[g.id],D=[];d(l.onAnalyzeRecords,{stage:"analyzeRecords",data:{message:{text:"importInfo.getLinkRecord",params:{indexValue:c.join("|"),fieldName:a.field.name,fieldId:r.id,table:g.name}}}});const W=c.map(M=>{const j=X.filter(P=>P.indexValue[0]===M);return j.length===0?(D.push(M),null):j.map(P=>P.recordId)}).flat().filter(M=>M!==null);if((!D.length||!b)&&W.length){const M=await E.getCell(r,a,W.join(a.config.separator??","));return M||null}}async function ne(e,a,r,s,t,n,d){if(!a.excel_field||!a.writable)return null;const u=e[a.excel_field]??null;if(!u)return null;const y=r[a.table].fields[a.field.id],b=re.includes(a.field.type),{linkConfig:A}=a,{primaryKey:c}=A??{};if(b&&a.hasChildren&&a.children?.length&&c)return await ue(u,a,y,r,s,t,n);if(E.asyncTypes.includes(a.field.type)&&await ce(u,a,y,r,s,t,n,d),!b){const g=await E.getCell(y,a,u);if(g)return g}return null}async function Ee(e,a){try{let r=!1;if(!a){const t=await e.addField({type:de.ModifiedTime});a=await e.getField(t),r=!0}const s=await a.getFieldValueList();return r&&e.deleteField(a),s.reduce((t,n)=>(n.record_id&&(t[n.record_id]=n.value),t),{})}catch(r){return $({title:"getModifiedTimeFailure",message:String(r),error:r,notice:!0,noticeParams:{text:"message.getModifiedTimeFailure",params:{id:e.id}}}),{}}}async function Ae(e,a,r){return await Promise.all(a.map(async t=>{r(l.onReadFieldMap,{stage:"readFieldMap",data:{message:{text:"importInfo.getFieldCellString",params:{field:e.id,record:t}}}});const n=await e.getCellString(t);return{recordId:t,value:n}}))}async function Ve(e,a,r){let s={};const t=e[0].table;s[t]=await ae(t,e,e[0].root,r,a);for(const n of e)if(n.excel_field&&n.hasChildren&&n.linkConfig&&!Object.keys(s).includes(n.field.property.tableId)){const d=n.field.property.tableId;s[d]=await ae(d,n.children??[],!1,r,n.linkConfig.primaryKey?[n.linkConfig.primaryKey]:void 0)}return s}async function ee(e,a=3){try{return await e()}catch(r){if(a<=0)throw r;return await ee(e,a-1)}}async function Me(e,a=he){let r=!0,s,t=[];for(;r;){const{hasMore:n,recordIds:d,pageToken:u}=await ee(async()=>await e.getRecordIdListByPage({pageSize:a,pageToken:s}));r=n,s=u,t.push(...d)}return t}async function Oe(e,a,r){const s=await Me(e);return await Promise.all(a.map(async n=>{const d=await e.getField(n.field.id);return r(l.onReadFieldMap,{stage:"readFieldMap",data:{message:{text:"importInfo.getIndexField",params:{name:n.field.name,id:n.field.id}}}}),{values:await Ae(d,s,r),fieldMap:n}})).then(async n=>Promise.all(s.map(async d=>{const u=[];for(const y of n){const b=y.values.find(c=>c.recordId===d)?.value??"";r(l.onReadFieldMap,{stage:"readFieldMap",data:{message:{text:"importInfo.analyzeIndexFieldValue",params:{fieldName:y.fieldMap.field.name,fieldId:y.fieldMap.field.id,recordId:d}}}});const A=await E.normalization(b,y.fieldMap,{separator:",",format:["yyyy/MM/dd","yyyy/MM/dd HH:mm","yyyy-MM-dd HH:mm","yyyy-MM-dd","MM-dd","MM/dd/yyyy","dd/MM/yyyy"]});u.push(A)}return{indexValue:u,table:e.id,recordId:d,fieldMaps:a}})).catch(d=>{throw $({title:"getTableIndexFailure",message:String(d),error:d,notice:!0,noticeParams:{text:"message.getTableIndexFailure",params:{id:e.id}}}),d}))}async function De(e){const a=[];let r;for(;;){const s=await ee(async()=>await e.getRecordsByPage({pageSize:be,pageToken:r}));if(r=s.pageToken,a.push(...s.records),!s.hasMore||!r)break}return a.reduce((s,t)=>(s[t.recordId]=t.fields,s),{})}async function ve(e,a,r,s){for(const t of e){if(!pe.includes(t.field.type))continue;const n=t.excel_field;if(!n)continue;s(l.onReadFieldMap,{stage:"readFieldMap",data:{message:{text:"importInfo.checkSelectFieldOptions",params:{fieldName:t.field.name,fieldId:t.field.id}}}});const d=r.map(c=>c[n]).filter(H),u=a[t.field.id],y=(await u.getOptions()).map(c=>c.name),A=C((await Promise.all(d.map(async c=>await E.normalization(c,t)))).filter(H).flat()).filter(c=>!y.includes(c));if(A.length){s(l.onReadFieldMap,{stage:"readFieldMap",data:{message:{text:"importInfo.setSelectFieldOptions",params:{fieldName:t.field.name,fieldId:t.field.id,newOptionsNum:String(A.length)}}}});try{await u.addOptions(A.map(c=>({name:c})))}catch(c){const g=await u.getName();$({title:"setSelectFieldOptionsFailure",message:`set select field ${g}[${u.id}] options failure`,error:c,notice:!0,noticeParams:{text:"message.setSelectFieldOptionsFailure",params:{id:t.field.id,name:g}}})}}}}async function ze(e,a,r,s=null,t=G.append,n={},d=ge){console.log(e),d(l.onStart,{stage:"start"}),E.refresh(),d(l.beforeReadFieldMap,{stage:"readFieldMap",data:{progress:!1}});const{parallel:u={records:1e4,fields:10},interval:y={records:0,fields:0},allowAction:b={add:!0,update:!0,delete:!0},updateOption:A={mode:[N.SAVE_MOST,N.SAVE_LATEST]}}=n;te({title:"importInfo.start",message:`
    Mode: ${t}
    SheetIndex: ${r}
    index: ${s}
    parallel:
      - fields: ${u.fields}
      - records: ${u.records}
    interval:
      - fields: ${y.fields}
      - records: ${y.records}
    allowAction:
      - add: ${b.add}
      - update: ${b.update}
      - delete: ${b.delete}
    updateOption:
      - mode: ${A.mode}
    `});const c=a.sheets[r].tableData.records,g=await Ve(e,s??[],d);me({title:"tables",message:JSON.stringify(g,null,2)});const X=[],D=g[e[0].table].table;let W={};if(t!==G.append){d(l.onReadFieldMap,{stage:"readFieldMap",data:{message:{text:"importInfo.getRecordsModifiedTime"}}});const f=e.find(h=>h.field.type===de.ModifiedTime)?.field.id,S=f?await D.getField(f):void 0;W=await Ee(D,S)}await ve(e,g[e[0].table].fields,c,d);const M={};await Promise.all(Object.values(g).map(async f=>{const S=f.indexId,h=await Oe(f.table,S.map(I=>f.fieldMaps.find(m=>m.field.id===I)),d);M[f.id]=h.map(I=>({...I,modifiedTime:W[I.recordId]??0}))})),s&&s.length&&X.push(...M[D.id]),d(l.onReadFieldMapEnd,{stage:"readFieldMap"});const j=[];if(d(l.beforeAnalyzeRecords,{stage:"analyzeRecords",data:{progress:!0,number:c.length,success:0,error:0}}),t===G.append||!s){const f=await se(c,async S=>{const h=[],I={table:{id:e[0].table,name:g[e[0].table].name},action:v.Add,data:[],result:void 0,status:_.Wait},m=[];for(const T of e){const F=await ne(S,T,g,M,h,d,I);F&&m.push(F)}return d(l.onAnalyzeRecords,{stage:"analyzeRecords",data:{number:c.length,success:1,error:0}}),m.length&&(I.data.push(...m),h.push(I)),h},u.records,y.records);j.push(...f)}else{const f=s.map(m=>{const T=e.find(F=>F.field.id===m);return T||null});te({title:"excelIndexField",message:JSON.stringify(f,null,2)}),d(l.onAnalyzeRecords,{stage:"analyzeRecords",data:{message:{text:"importInfo.getTableRecords",params:{table:D.id}}}});const S=await De(D),h=[],I=await se(c,async m=>{const T=[],F=await Promise.all(f.map(async o=>await E.normalization(m[o.excel_field]??"",o))),L=X.filter(o=>fe(o.indexValue,F));d(l.onAnalyzeRecords,{stage:"analyzeRecords",data:{message:{text:"importInfo.findSameRecord",params:{indexValue:F.join("|"),number:String(L.length)}}}});const O=[];let V=null;if(L.length>=1){for(const o of L){d(l.onAnalyzeRecords,{stage:"analyzeRecords",data:{message:{text:"importInfo.getSameRecord",params:{indexValue:F.join("|"),recordId:o.recordId}}}});const w=S[o.recordId],R={...o,tableValues:Object.keys(w).reduce((p,i)=>(w[i]!==null&&(p[i]=w[i]),p),{})};O.push(R)}if(O.length>1){const{mode:o}=A;if([N.SAVE_LATEST,N.SAVE_OLDEST].includes(o[0])){const w=C(O.map(i=>i.modifiedTime)),R=o[0]===N.SAVE_LATEST?Math.max(...w):Math.min(...w),p=O.filter(i=>i.modifiedTime===R);if(p.length===1){const i=p[0];V={id:i.recordId,table:i.table,tableValues:i.tableValues}}else{p.sort((Q,B)=>Object.values(Q.tableValues).length-Object.values(B.tableValues).length);const i=o[1]===N.SAVE_MOST?p[p.length-1]:p[0];V={id:i.recordId,table:i.table,tableValues:i.tableValues}}}else{const w=C(O.map(i=>Object.values(i.tableValues).length)),R=o[0]===N.SAVE_MOST?Math.max(...w):Math.min(...w),p=O.filter(i=>Object.values(i.tableValues).length===R);if(p.length===1){const i=p[0];V={id:i.recordId,table:i.table,tableValues:i.tableValues}}else{p.sort((Q,B)=>Q.modifiedTime-B.modifiedTime);const i=o[1]===N.SAVE_LATEST?p[p.length-1]:p[0];V={id:i.recordId,table:i.table,tableValues:i.tableValues}}}if(H(V)){const w=O.map(R=>R.recordId).filter(R=>R!==V.id).filter(R=>!h.includes(R));h.push(...w),T.push(...w.map(R=>({table:{id:D.id,name:g[D.id].name},action:v.Delete,data:[R],result:void 0,status:_.Wait})))}}else{const o=O[0];V={id:o.recordId,table:o.table,tableValues:o.tableValues}}}const x={table:{id:D.id,name:g[D.id].name},action:v.Add,data:[],result:void 0,status:_.Wait},z=[];for(const o of e){if(!o.excel_field||!o.writable)continue;const w=m[o.excel_field]??"",R=g[o.table].fields[o.field.id];if(d(l.onAnalyzeRecords,{stage:"analyzeRecords",data:{message:{text:"importInfo.compareRecordField",params:{fieldName:o.field.name,fieldId:R.id,indexValue:F.join("|")}}}}),b.add&&!L.length){const K=await ne(m,o,g,M,T,d,x);z.push(K)}if(!b.update||!V)continue;const p=re.includes(o.field.type),{linkConfig:i}=o,{primaryKey:Q}=i??{},B=V.tableValues[o.field.id]??null;if(p&&o.hasChildren&&o.children?.length&&Q&&(t===G.merge_direct||B===null)){const K=await ue(w,o,R,g,M,j,d);z.push(K)}if(E.asyncTypes.includes(o.field.type)&&await ce(w,o,R,g,M,j,d,x),!p){const K=await xe(w,B,t,R,o);K&&z.push(K)}}if(d(l.onAnalyzeRecords,{stage:"analyzeRecords",data:{number:c.length,success:1,error:0}}),O.length){x.action=v.Update;const o={};for(const R of z.filter(p=>p!==null)){const[p,i]=await Promise.all([R.getFieldId(),R.getValue()]);o[p]=i}const w={recordId:V.id,fields:o};return x.data.push(w),T.push(x),T}return x.data.push(...z.filter(o=>o!==null)),T.push(x),T},u.records,y.records);j.push(...I)}d(l.onAnalyzeRecordsEnd,{stage:"analyzeRecords"});const P=U(j,"action"),q=P[v.Async];if(q&&q.length){const f=U(q,"asyncField.field.type"),S=Object.keys(f),h=S.reduce((m,T)=>(m[T]=f[T].map(F=>F.data).flat(),m),{});d(l.beforeAsyncData,{stage:"asyncData",data:{progress:!0,number:q.length,success:[],error:[]}});for(const m of S){const T=f[m];await E.asyncMethod({data:h[m],onProgress:F=>{const{message:L="",loaded:O,total:V}=F;d(l.onAsyncData,{stage:"asyncData",data:{message:{text:L+`
${O}/${V}`}}})},onError:F=>{$({title:"asyncDataFailure",message:String(F),error:F})}},T[0].asyncField)}const I=U(q,"table.id");for(const m of Object.keys(I)){const T=g[m],F=I[m],L=U(F,"asyncField.field.id");for(const O of Object.keys(L)){const V=T.fields[O];for(const x of L[O]){d(l.onAsyncData,{stage:"asyncData",data:{message:{text:"importInfo.createCell",params:{fieldId:V.id,tableId:m}}}});const z=await E.getCell(V,x.asyncField,x.value);if(!(!z||!x.target)){if(x.target.action===v.Add)x.target.data.push(z);else if(x.target.action===v.Update){const[o,w]=await Promise.all([z.getFieldId(),z.getValue()]);x.target.data[0].fields[o]=w}x.status=_.Success}}}}d(l.onAsyncDataEnd,{stage:"asyncData"})}const Y=P[v.Delete];if(Y&&b.delete&&Y.length){d(l.beforeDeleteRecords,{stage:"deleteRecords",data:{progress:!0,number:Y.length,success:[],error:[]}});const f=U(Y,"table.id"),S=Object.keys(f);for(const h of S){const I=g[h],m=f[h];await Se(m,I.table,le,0,d)}d(l.onDeleteRecordsEnd,{stage:"deleteRecords"})}const J=P[v.Add];if(J&&(t===G.append||b.add)&&J&&J.length){d(l.beforeAddRecords,{stage:"addRecords",data:{progress:!0,number:J.length,success:[],error:[]}});const f=U(J,"table.id"),S=Object.keys(f);for(const h of S){const I=g[h],m=f[h];await Te(m,I.table,oe,0,d)}d(l.onAddRecordsEnd,{stage:"addRecords"})}const Z=P[v.Update];if(Z&&b.update&&Z.length){d(l.beforeUpdateRecords,{stage:"updateRecords",data:{progress:!0,number:Z.length,success:[],error:[]}});const f=U(Z,"table.id"),S=Object.keys(f);for(const h of S){const I=g[h],m=f[h];await Fe(m,I.table,ie,0,d)}d(l.onUpdateRecordsEnd,{stage:"updateRecords"})}E.reset(),d(l.onEnd,{stage:"end"})}export{ze as importExcel};
